# 功能规格说明：对话历史与用户管理

**功能分支**: `002-conversation-user-management`
**创建日期**: 2026-02-08
**状态**: 草稿
**输入**: 用户描述: "对话历史管理和用户管理功能"

## 概述

为 Sunny Agent 添加完整的对话历史管理和用户认证系统。采用左树右表的布局方式重构页面，左侧包含导航菜单（可收缩），右侧保持现有对话界面。同时引入用户角色系统（管理员/普通用户）和统一的数据持久化方案。

**范围说明**：
- 系统管理模块仅对管理员用户可见
- 本期系统管理只实现用户管理功能，后续可扩展其他管理功能

**设计约束**：
- 所有新增界面必须与现有对话界面的设计风格保持一致（配色、字体、间距、组件样式等）

## 用户场景与测试 *(必填)*

### 用户故事 1 - 用户登录 (优先级: P1)

用户打开应用，看到登录页面，输入用户名和密码后进入主界面。未登录用户无法访问任何功能。

**优先级理由**: 安全基础 - 所有其他功能都依赖于用户认证。

**独立测试**: 可通过使用正确/错误凭据登录进行完整测试，验证成功登录后跳转主界面，失败时显示错误提示。

**验收场景**:

1. **假设** 用户未登录，**当** 访问任何页面，**则** 重定向到登录页面
2. **假设** 登录页面，**当** 输入正确的用户名和密码，**则** 成功登录并跳转到主界面
3. **假设** 登录页面，**当** 输入错误的凭据，**则** 显示"用户名或密码错误"提示
4. **假设** 用户已禁用，**当** 尝试登录，**则** 显示"账户已被禁用，请联系管理员"

---

### 用户故事 2 - 左树右表布局与导航 (优先级: P1)

用户登录后看到左树右表的主界面布局。左侧导航栏包含新建对话按钮、对话文件夹、系统管理和登录管理入口。左侧导航栏可以收缩/展开。

**优先级理由**: 核心布局 - 定义整体交互框架，后续功能都在此布局中展现。

**独立测试**: 可通过登录后查看布局、点击收缩按钮、点击各导航项进行完整测试。

**验收场景**:

1. **假设** 用户已登录，**当** 进入主界面，**则** 看到左侧导航栏和右侧对话区域
2. **假设** 左侧导航栏展开状态，**当** 点击收缩按钮，**则** 导航栏收缩为图标模式
3. **假设** 左侧导航栏收缩状态，**当** 点击展开按钮，**则** 导航栏展开显示完整内容
4. **假设** 导航栏中，**当** 点击"新建对话"，**则** 右侧开始新的对话会话

---

### 用户故事 3 - 对话历史管理 (优先级: P1)

用户可以在左侧对话文件夹中看到所有历史对话列表。点击某个对话可以重新打开继续。可以删除不需要的对话。

**优先级理由**: 核心价值 - 让用户能够管理和回顾历史对话，提升使用效率。

**独立测试**: 可通过创建对话、在列表中查看、点击打开、删除对话进行完整测试。

**验收场景**:

1. **假设** 用户完成一次对话，**当** 查看对话文件夹，**则** 该对话出现在列表中，显示标题和时间
2. **假设** 对话文件夹中有历史对话，**当** 点击某个对话，**则** 右侧加载该对话的完整历史
3. **假设** 对话文件夹中有历史对话，**当** 点击删除按钮，**则** 显示确认提示
4. **假设** 确认删除对话，**当** 点击确认，**则** 对话从列表中移除

---

### 用户故事 4 - 管理员用户管理 (优先级: P2)

管理员可以进入系统管理，当前系统管理只包含用户管理功能。在用户管理页面，管理员可以查看所有用户列表，创建新用户，禁用/启用用户，删除用户。

**优先级理由**: 管理功能 - 支持多用户环境的用户生命周期管理。

**独立测试**: 可通过管理员登录、进入系统管理-用户管理、执行CRUD操作进行完整测试。

**验收场景**:

1. **假设** 管理员已登录，**当** 点击"系统管理"，**则** 进入系统管理页面，当前只显示用户管理功能
2. **假设** 用户管理页面，**当** 点击"创建用户"，**则** 显示创建用户表单
3. **假设** 创建用户表单，**当** 填写用户名、密码、角色并提交，**则** 新用户创建成功
4. **假设** 用户列表中，**当** 点击"禁用"按钮，**则** 用户状态变为禁用
5. **假设** 用户列表中，**当** 点击"启用"按钮，**则** 用户状态变为启用
6. **假设** 用户列表中，**当** 点击"删除"并确认，**则** 用户从系统中移除

---

### 用户故事 5 - 普通用户权限限制 (优先级: P2)

普通用户登录后只能看到对话相关功能，无法访问系统管理和用户管理功能。

**优先级理由**: 安全控制 - 确保权限分离，普通用户无法执行管理操作。

**独立测试**: 可通过普通用户登录，验证看不到管理入口，直接访问管理URL被拒绝。

**验收场景**:

1. **假设** 普通用户已登录，**当** 查看左侧导航，**则** 不显示"系统管理"入口
2. **假设** 普通用户已登录，**当** 直接访问用户管理页面URL，**则** 显示"无权限访问"
3. **假设** 普通用户已登录，**当** 使用对话功能，**则** 功能正常可用

---

### 用户故事 6 - 用户退出登录 (优先级: P2)

用户可以在登录管理区域退出当前账户，退出后返回登录页面。

**优先级理由**: 基础安全 - 允许用户安全退出，特别是在共享设备上。

**独立测试**: 可通过点击退出按钮，验证会话结束并返回登录页进行完整测试。

**验收场景**:

1. **假设** 用户已登录，**当** 点击"登录管理"区域的退出按钮，**则** 会话结束
2. **假设** 会话结束后，**当** 尝试访问任何页面，**则** 重定向到登录页
3. **假设** 退出后，**当** 重新登录，**则** 不保留之前的会话状态

---

### 用户故事 7 - 对话自动命名 (优先级: P3)

系统根据对话的第一条消息自动生成对话标题，用户也可以手动修改标题。

**优先级理由**: 体验优化 - 帮助用户快速识别历史对话内容。

**独立测试**: 可通过开始对话后查看列表中的标题，以及手动编辑标题进行完整测试。

**验收场景**:

1. **假设** 新对话中，**当** 用户发送第一条消息，**则** 系统自动生成对话标题
2. **假设** 对话列表中，**当** 双击对话标题，**则** 进入编辑模式
3. **假设** 编辑对话标题，**当** 输入新标题并确认，**则** 标题更新成功

---

### 用户故事 8 - 数据迁移与持久化 (优先级: P3)

系统将现有的 SQLite 数据迁移到统一的数据存储，确保对话历史、用户信息等数据的持久化和一致性。

**优先级理由**: 技术基础 - 为多用户和数据管理提供可靠的存储层。

**独立测试**: 可通过创建数据、重启服务、验证数据完整性进行完整测试。

**验收场景**:

1. **假设** 用户创建对话，**当** 服务重启后，**则** 对话数据完整保留
2. **假设** 管理员创建用户，**当** 服务重启后，**则** 用户数据完整保留
3. **假设** 多用户同时操作，**当** 各自保存数据，**则** 数据互不干扰

---

### 边缘情况

- 用户删除正在进行的对话时会发生什么？
  - 显示确认提示"当前对话将被删除，是否继续？"，确认后清空右侧对话区并刷新列表
- 管理员删除自己的账户时会发生什么？
  - 禁止删除自己的账户，显示"无法删除当前登录的账户"
- 系统只有一个管理员时删除该管理员会发生什么？
  - 禁止删除最后一个管理员，显示"系统至少需要保留一个管理员"
- 用户会话超时时会发生什么？
  - 自动跳转到登录页，显示"会话已过期，请重新登录"
- 对话标题过长时如何显示？
  - 截断显示，鼠标悬停显示完整标题
- 对话列表数量过多时如何处理？
  - 分页加载或虚拟滚动，保证界面流畅
- 对话列表为空时如何展示？
  - 显示引导提示，如"点击新建对话开始"，帮助新用户快速上手

## 需求 *(必填)*

### 功能需求

#### 用户认证
- **FR-001**: 系统必须提供用户登录功能，支持用户名和密码认证
- **FR-002**: 系统必须在用户未登录时拒绝访问任何功能页面
- **FR-003**: 系统必须支持用户退出登录功能
- **FR-004**: 系统必须支持会话管理，会话超时后自动登出

#### 用户管理
- **FR-005**: 系统必须支持两种用户角色：管理员和普通用户
- **FR-006**: 管理员必须能够查看所有用户列表
- **FR-007**: 管理员必须能够创建新用户，指定用户名、密码（无强度限制）和角色
- **FR-008**: 管理员必须能够禁用/启用用户账户
- **FR-009**: 管理员必须能够删除用户（除自己和最后一个管理员外）
- **FR-010**: 普通用户不能访问用户管理功能
- **FR-011**: 系统必须在首次启动时创建默认管理员账户

#### 页面布局
- **FR-012**: 系统必须采用左树右表的布局方式
- **FR-013**: 左侧导航栏必须支持收缩/展开功能
- **FR-014**: 左侧导航栏必须包含：新建对话、对话文件夹、系统管理（仅管理员可见，当前只含用户管理）、登录管理
- **FR-015**: 右侧区域必须保持现有的对话界面功能
- **FR-016**: 所有新增界面必须与现有对话界面的设计风格保持一致（配色、字体、间距、组件样式）

#### 对话历史管理
- **FR-017**: 系统必须保存每次对话到用户的对话文件夹
- **FR-018**: 系统必须在对话列表中显示对话标题和创建时间
- **FR-019**: 用户必须能够点击历史对话重新打开并继续
- **FR-020**: 用户必须能够删除历史对话
- **FR-021**: 系统必须根据第一条消息自动生成对话标题
- **FR-022**: 用户必须能够手动修改对话标题
- **FR-023**: 对话历史必须按用户隔离，用户只能看到自己的对话

#### 数据持久化
- **FR-024**: 系统必须将所有数据统一存储管理
- **FR-025**: 系统必须确保数据在服务重启后完整保留
- **FR-026**: 系统必须支持多用户并发操作的数据一致性

### 关键实体

- **用户 (User)**: 系统使用者，具有唯一标识符、用户名（字母数字下划线，3-20字符，唯一）、密码哈希、角色（管理员/普通用户）、状态（启用/禁用）、创建时间
- **对话 (Conversation)**: 用户与 AI 的对话会话，具有唯一标识符、标题、所属用户、创建时间、更新时间
- **消息 (Message)**: 对话中的单条交互，具有唯一标识符、所属对话、角色（用户/助手）、内容、工具调用信息、创建时间
- **会话 (Session)**: 用户的登录会话，具有唯一标识符、所属用户、创建时间、过期时间

## 成功标准 *(必填)*

### 可衡量结果

- **SC-001**: 用户登录操作在 2 秒内完成响应
- **SC-002**: 用户可以在 3 次点击内找到并打开任意历史对话
- **SC-003**: 对话列表支持至少 1000 条对话记录而不出现性能下降
- **SC-004**: 左侧导航栏收缩/展开动画流畅，无明显卡顿
- **SC-005**: 管理员可以在 1 分钟内完成创建新用户的操作
- **SC-006**: 数据在服务重启后 100% 完整保留
- **SC-007**: 10 个并发用户操作时系统响应正常
- **SC-008**: 未授权访问请求 100% 被正确拦截

## 澄清记录

### 会话 2026-02-08

- Q: 创建用户时，密码需要满足什么强度要求？ → A: 无限制（任意密码即可）
- Q: 用户连续多次登录失败时，系统如何处理？ → A: 无限制（仅显示错误，不做限制）
- Q: 用户名需要满足什么规则？ → A: 标准格式（字母数字下划线，3-20字符，需唯一）
- Q: 对话列表为空时，界面如何展示？ → A: 显示引导提示（如"点击新建对话开始"）
- Q: 默认管理员账户的初始密码如何设置？ → A: 环境变量配置（部署时指定）

## 假设条件

- 用户使用现代浏览器访问系统
- 网络连接稳定
- 首次部署时会创建默认管理员账户（用户名: admin，密码通过环境变量配置）
- 密码存储使用安全的哈希算法，密码本身无强度限制
- 登录失败无次数限制，仅显示错误提示
- 会话有效期为 24 小时，可配置
- 对话标题自动生成时取第一条消息的前 50 个字符
- 对话列表默认按更新时间倒序排列
- 系统管理模块采用可扩展设计，本期只实现用户管理，后续可添加其他管理功能
