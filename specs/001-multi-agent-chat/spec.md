# 功能规格说明：多 Agent 对话系统

**功能分支**: `001-multi-agent-chat`
**创建日期**: 2026-02-08
**状态**: 已实现
**输入**: 用户描述: "docs/feature-description.md"

## 概述

一个智能对话 AI 系统，根据任务类型将用户消息智能路由到专业 Agent。用户通过单一对话界面交互，系统自动将工作委派给最合适的专家（网页研究、数据库查询、文件处理或代码执行）。

## 用户场景与测试 *(必填)*

### 用户故事 1 - 基础对话 (优先级: P1)

用户打开对话界面，发送简单问题或问候。系统直接响应，无需路由到专业 Agent。

**优先级理由**: 核心功能 - 所有用户交互从这里开始。必须可靠运行，后续功能才有意义。

**独立测试**: 可通过发送"你好"或"2+2等于多少？"进行完整测试，应收到即时、合理的响应，无可见的 Agent 委派。

**验收场景**:

1. **假设** 新对话会话，**当** 用户发送"你好"，**则** 系统在 3 秒内响应问候
2. **假设** 对话会话中，**当** 用户询问简单数学问题，**则** 系统直接计算并响应
3. **假设** 对话会话中，**当** 用户询问常识问题，**则** 系统直接回答，不显示路由指示器

---

### 用户故事 2 - 深度研究 (优先级: P1)

用户提出需要互联网当前信息的问题。系统路由到研究专家，搜索网页，返回带引用的综合报告。

**优先级理由**: 主要差异化特性 - 用户需要获取 AI 训练数据之外的当前信息。

**独立测试**: 可通过询问"AI 监管的最新进展是什么？"进行完整测试，应收到带引用来源的响应。

**验收场景**:

1. **假设** 对话会话中，**当** 用户询问时事，**则** 系统搜索网页并返回带来源链接的信息
2. **假设** 研究请求中，**当** 系统收集信息，**则** 响应包含编号引用和来源章节
3. **假设** 复杂研究主题，**当** 系统需要多次搜索，**则** 用户看到思考/进度指示器

---

### 用户故事 3 - 数据库查询 (优先级: P2)

用户询问音乐数据库中的数据（艺术家、专辑、曲目、客户）。系统路由到 SQL 专家，构造查询，返回格式化结果。

**优先级理由**: 展示专业数据访问能力，但使用场景比网页研究更窄。

**独立测试**: 可通过询问"Led Zeppelin 有多少张专辑？"进行完整测试，应收到准确数量。

**验收场景**:

1. **假设** 对话会话中，**当** 用户询问音乐数据库内容，**则** 系统查询数据库并返回准确结果
2. **假设** 复杂数据问题，**当** 系统需要多次查询，**则** 用户看到查询进度
3. **假设** 无效数据请求，**当** 数据不存在，**则** 系统提供有用响应解释限制

---

### 用户故事 4 - 文件上传与处理 (优先级: P2)

用户上传文档（PDF、Word、Excel、PowerPoint）并询问其内容。系统读取分析文件，根据内容响应。

**优先级理由**: 支持用户常需的以文档为中心的工作流程。

**独立测试**: 可通过上传 PDF 并询问"这个文档讲什么？"进行完整测试，应收到摘要。

**验收场景**:

1. **假设** 对话会话中，**当** 用户上传支持的文件，**则** 显示上传进度并确认文件就绪
2. **假设** 已上传 PDF，**当** 用户询问内容，**则** 系统提取分析文本来回答
3. **假设** Excel 文件，**当** 用户要求摘要，**则** 系统读取表格数据并提供分析
4. **假设** 不支持的文件类型，**当** 用户尝试上传，**则** 系统显示清晰错误解释允许的类型

---

### 用户故事 5 - 代码生成与文件输出 (优先级: P3)

用户请求生成文档（PowerPoint、PDF、报告）。系统生成代码，在沙箱中执行，提供结果文件的下载链接。

**优先级理由**: 基于文件处理的高级能力；使用较少但价值高。

**独立测试**: 可通过请求"创建一个关于气候变化的 PPT"进行完整测试，应收到可下载的 .pptx 文件。

**验收场景**:

1. **假设** 文档生成请求，**当** 用户要求创建演示文稿，**则** 系统生成并提供下载链接
2. **假设** 代码执行进行中，**当** 系统工作时，**则** 用户看到执行进度
3. **假设** 代码执行完成，**当** 文件生成后，**则** 下载链接有效且文件可用

---

### 用户故事 6 - 技能激活 (优先级: P3)

用户使用斜杠命令调用特定技能（如 /pdf、/web-scraping）。系统加载技能指令并应用于处理用户请求。

**优先级理由**: 高级用户功能，用于专业工作流程；需要了解可用技能。

**独立测试**: 可通过输入"/pdf 总结这个文档"配合已上传的 PDF 进行完整测试，应收到技能增强的响应。

**验收场景**:

1. **假设** 对话会话中，**当** 用户在输入框输入"/"，**则** 技能建议出现
2. **假设** 可用技能列表，**当** 用户选择技能，**则** 技能名称出现在输入框中
3. **假设** 技能增强的请求，**当** 用户发送消息，**则** 技能指令应用于响应

---

### 用户故事 7 - 直接选择 Agent (优先级: P3)

用户在发送消息前明确选择使用哪个 Agent（研究、数据库、通用）。系统绕过 Supervisor 直接路由到选定的 Agent。

**优先级理由**: 高级用户功能，适合知道自己需要哪个 Agent 的经验用户。

**独立测试**: 可通过点击"研究"Agent 芯片并发送消息进行完整测试，验证消息直接发送到研究 Agent。

**验收场景**:

1. **假设** 输入区域，**当** 未选择 Agent，**则** Agent 选择器芯片可见
2. **假设** 可用 Agent 列表，**当** 用户点击 Agent 芯片，**则** Agent 被选中，芯片折叠显示选择
3. **假设** 已选择 Agent，**当** 用户发送消息，**则** 消息直接路由到该 Agent
4. **假设** 已选择 Agent，**当** 用户点击选择上的 X，**则** Agent 被取消选择，选择器重新出现

---

### 用户故事 8 - 对话持久化 (优先级: P2)

用户返回之前的对话线程，从上次中断处继续。系统保持之前消息的完整上下文。

**优先级理由**: 多会话工作流程和用户体验连续性的必要功能。

**独立测试**: 可通过开始对话、刷新页面、验证之前的消息已恢复进行完整测试。

**验收场景**:

1. **假设** 活跃对话中，**当** 用户发送多条消息，**则** 每个响应都考虑完整对话历史
2. **假设** 之前的线程 ID，**当** 用户返回，**则** 完整消息历史被恢复
3. **假设** 新会话，**当** 用户重新开始，**则** 生成新的线程 ID

---

### 边缘情况

- 文件上传超过 10MB 限制时会发生什么？
  - 系统显示清晰错误，包含大小限制信息
- 网页研究期间网络超时如何处理？
  - 研究 Agent 重试，如果可用则提供部分结果
- 数据库查询返回空结果时会发生什么？
  - SQL Agent 提供有用消息解释未找到匹配数据
- 代码执行超时如何处理？
  - 沙箱强制超时并返回错误解释限制
- 响应仍在流式传输时用户发送消息会发生什么？
  - 流式传输期间输入被禁用；用户可以取消当前响应
- 文件上传格式错误如何处理？
  - 文件解析错误被捕获，用户收到有用的错误消息

## 需求 *(必填)*

### 功能需求

#### 对话核心
- **FR-001**: 系统必须直接响应简单问题，无可见路由
- **FR-002**: 系统必须在会话内多条消息间保持对话上下文
- **FR-003**: 系统必须持久化对话历史，使用户可以继续之前的线程
- **FR-004**: 系统必须实时流式响应，显示生成的文本

#### 智能路由
- **FR-005**: 系统必须自动为每个用户请求确定合适的专家
- **FR-006**: 系统必须支持通过 UI 中的 Agent 选择进行显式路由
- **FR-007**: 系统必须在委派给专家时显示思考/路由指示器
- **FR-008**: 系统必须支持将复杂任务路由到多步骤任务编排器

#### 网页研究
- **FR-009**: 当问题需要时，系统必须搜索网页获取当前信息
- **FR-010**: 系统必须在研究响应中包含引用和来源链接
- **FR-011**: 系统必须获取并处理完整网页内容以提供全面答案
- **FR-012**: 系统必须限制搜索迭代以防止过度 API 使用（最多 5 次搜索）

#### 数据库查询
- **FR-013**: 系统必须查询音乐数据库来回答数据问题
- **FR-014**: 系统必须以可读格式显示查询结果
- **FR-015**: 系统必须优雅处理无效查询，提供有用的错误消息

#### 文件处理
- **FR-016**: 系统必须接受最大 10MB 的文件上传
- **FR-017**: 系统必须支持 PDF、Word (.docx)、Excel (.xlsx)、PowerPoint (.pptx) 和文本文件
- **FR-018**: 系统必须在文件传输期间显示上传进度
- **FR-019**: 系统必须从上传的文件中提取和分析内容
- **FR-020**: 系统必须拒绝不支持的文件类型，并显示清晰错误消息

#### 代码执行
- **FR-021**: 系统必须在隔离的沙箱环境中执行 Python 代码
- **FR-022**: 系统必须支持生成可下载文件（演示文稿、文档等）
- **FR-023**: 系统必须为生成的文件提供下载链接
- **FR-024**: 系统必须强制执行安全限制（无网络访问、有限资源）

#### 技能系统
- **FR-025**: 当用户在输入框中输入"/"时，系统必须显示可用技能
- **FR-026**: 系统必须允许通过建议下拉菜单或技能选择器选择技能
- **FR-027**: 系统必须在处理请求时应用特定技能的指令
- **FR-028**: 系统必须支持从外部来源加载多个技能

#### 用户界面
- **FR-029**: 当未明确选择 Agent 时，系统必须显示 Agent 选择器
- **FR-030**: 系统必须将选中的 Agent 显示为可关闭的芯片
- **FR-031**: 系统必须显示工具调用及其参数和结果
- **FR-032**: 系统必须允许取消正在进行的响应
- **FR-033**: 系统必须支持开始新的对话线程

### 关键实体

- **线程 (Thread)**: 具有唯一标识符的对话会话，包含消息历史和持久化状态
- **消息 (Message)**: 单个交换单元，具有角色（用户/助手）、内容、可选文件附件和工具调用引用
- **Agent**: 具有唯一名称、描述、能力和关联工具的专家处理器
- **技能 (Skill)**: 增强 Agent 行为的指令集，具有名称、描述和激活触发器
- **工具调用 (ToolCall)**: 具有标识符、名称、参数、状态和结果的函数调用
- **上传文件 (UploadedFile)**: 用户提供的文档，具有标识符、文件名、大小、类型和存储位置

## 成功标准 *(必填)*

### 可衡量结果

- **SC-001**: 用户在 3 秒内收到简单问题的响应
- **SC-002**: 研究查询在 30 秒内返回至少带 2 个引用来源的综合答案
- **SC-003**: 5MB 以下的文件上传在 5 秒内完成并可用
- **SC-004**: 生成的文件（演示文稿、文档）在请求后 60 秒内可下载
- **SC-005**: 95% 的用户请求成功路由到合适的 Agent，无需人工干预
- **SC-006**: 用户返回应用程序后可以继续之前的对话
- **SC-007**: 流式响应在发送消息后 2 秒内显示第一个文本
- **SC-008**: 系统处理 10 个并发对话而不降级
- **SC-009**: 所有工具操作在启动后 1 秒内向用户显示进度/状态
- **SC-010**: 用户可以在单个会话中成功完成基于文件的工作流程（上传、分析、响应）

## 假设条件

- 用户使用启用 JavaScript 的现代网页浏览器
- 用户有稳定的互联网连接用于实时流式传输
- 音乐数据库（Chinook）已预填充示例数据
- 外部搜索 API（Tavily）可用且有足够配额
- Docker 可用于沙箱代码执行
- LLM API（Anthropic）可用且有适当的速率限制
- 文件存储使用临时目录，遵循标准操作系统清理策略
